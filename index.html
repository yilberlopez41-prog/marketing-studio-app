<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marketing Studio AI</title>
    <meta name="theme-color" content="#7c3aed">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <style>body { font-family: sans-serif; background-color: #f8fafc; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const Icon = ({ name }) => {
            const [s, setS] = useState('');
            useEffect(() => { if(window.lucide) setS(lucide.icons[name]?.toSvg()||''); }, [name]);
            return <span dangerouslySetInnerHTML={{__html: s}} style={{display:'inline-flex'}}/>;
        };

        const App = () => {
            const [product, setProduct] = useState("");
            const [platform, setPlatform] = useState("Instagram");
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            const generate = async () => {
                if(!product) return alert("Escribe un producto");
                setLoading(true); setError(""); setResult(null);

                try {
                    // AQUÍ ESTÁ LA CONEXIÓN AL SERVIDOR
                    const res = await fetch('/api/server', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'text',
                            prompt: `Experto Marketing. Post para ${platform} sobre: ${product}. JSON: {"copy": "texto", "hashtags": "#tags", "imagePrompt": "visual"}`
                        })
                    });

                    // SI VERCEL FALLA, AQUÍ CAPTURAMOS EL ERROR
                    if(!res.ok) {
                        if(res.status === 404) throw new Error("ERROR 404: Vercel no encuentra el archivo 'api/server.js'. Revisa el nombre en GitHub.");
                        if(res.status === 500) throw new Error("Error 500: Falló el servidor. Revisa si la API KEY es válida.");
                        throw new Error(`Error ${res.status}`);
                    }
                    
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);

                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    setResult(JSON.parse(text));
                } catch(e) { setError(e.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
                        <h1 className="text-2xl font-bold mb-6 text-purple-600">Marketing Studio</h1>
                        <input className="w-full p-3 border rounded mb-4" placeholder="Ej: Zapatos" value={product} onChange={e=>setProduct(e.target.value)}/>
                        
                        <div className="flex gap-2 mb-4">
                             {['Instagram', 'TikTok'].map(p => (
                                <button key={p} onClick={()=>setPlatform(p)} className={`flex-1 p-2 rounded border text-xs font-bold ${platform===p?'bg-purple-100 text-purple-700':''}`}>{p}</button>
                             ))}
                        </div>

                        <button onClick={generate} disabled={loading} className="w-full py-3 bg-purple-600 text-white rounded font-bold">
                            {loading ? "Conectando..." : "Generar"}
                        </button>
                        
                        {error && <div className="mt-4 text-red-500 bg-red-50 p-3 rounded text-sm font-mono border border-red-200">{error}</div>}
                        {result && <div className="mt-4 p-4 bg-gray-50 rounded"><p>{result.copy}</p></div>}
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
